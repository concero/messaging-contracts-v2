import { task } from "hardhat/config";

import { getNetworkEnvKey } from "@concero/contract-utils";
import { type HardhatRuntimeEnvironment } from "hardhat/types";
import { Hex, encodeAbiParameters, encodePacked } from "viem";
import { privateKeyToAccount } from "viem/accounts";

import { conceroNetworks } from "../../constants";
import { ConceroTestnetNetworkNames } from "../../constants/conceroNetworks";
import { getEnvVar, getFallbackClients, log } from "../../utils";

async function submitMessage(networkName: ConceroTestnetNetworkNames) {
	const network = conceroNetworks[networkName];
	const { walletClient, publicClient } = getFallbackClients(
		network,
		privateKeyToAccount("0x" + getEnvVar("RELAYER_PRIVATE_KEY")),
	);

	const conceroRouter = getEnvVar(`CONCERO_ROUTER_PROXY_${getNetworkEnvKey(networkName)}`);
	const { abi } = await import(
		"../../artifacts/contracts/ConceroRouter/ConceroRouter.sol/ConceroRouter.json"
	);

	const rawReport =
		"0x016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309";
	const reportContext =
		"0x000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000";
	const signatures = [
		"0x38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701",
		"0xe0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900",
		"0xfe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00",
		"0x8cacad3d8fb34a0901c142147b0decd61e0e81df33ad284504005f77b99a3b7769ef3e50ba44766f8fa505d88b863f6dc7a95fcbab4fd0910bec06bb9a14725700",
		"0xdd03d93eb6072e20c26abffa5f1deeeae9e8468fcb1d2b557c37ec8277c45a610aa0e607c3ab2d95c6d2d97ab01ac679311ab05be7c709ff7929523faa28ef4100",
		"0x6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00",
		"0x8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001",
		"0x914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01",
		"0xcc44f7db90cddf9a7e2c6cf57774235963ab3a75fc0f37e302aff9861021463a2119cf1a49702b80ae77ba78503463e53f3268fc37b9dce5342ecba16fa4146c01",
	];
	const validations = encodePacked(
		["bytes", "bytes", "bytes"],
		[
			reportContext as Hex,
			rawReport as Hex,
			encodeAbiParameters(
				signatures.map(() => ({ type: "bytes" })),
				signatures,
			),
		],
	);

	// 0x01013882066eee000000000000000000000000000000000000000000000000000000000000000400001c07035637b260fbb1021a26bfe016306ecd09f3eb0000000000000000000018b87c9c797d6a888536eda952c5fb2b66351cc5fd000493e00000010000000100000000000100000601000000000000000c48656c6c6f20776f726c6421

	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701","signerId":0},{"signature":"8cacad3d8fb34a0901c142147b0decd61e0e81df33ad284504005f77b99a3b7769ef3e50ba44766f8fa505d88b863f6dc7a95fcbab4fd0910bec06bb9a14725700","signerId":1},{"signature":"759952eddc35ce80488b0a6a7d0c9bef8d5e0718f89e6ed8b184f44ef5ad3c7649413d6f5eb71acbef83aafc343f0f00a3d68523f7e563b4b398507a15e10e1101","signerId":2},{"signature":"8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001","signerId":3}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4},{"signature":"fe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00","signerId":5},{"signature":"6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00","signerId":8},{"signature":"914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01","signerId":9}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4},{"signature":"fe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00","signerId":5},{"signature":"6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00","signerId":8},{"signature":"914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01","signerId":9}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4},{"signature":"fe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00","signerId":5},{"signature":"6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00","signerId":8},{"signature":"914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01","signerId":9}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	//  {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701","signerId":0},{"signature":"8cacad3d8fb34a0901c142147b0decd61e0e81df33ad284504005f77b99a3b7769ef3e50ba44766f8fa505d88b863f6dc7a95fcbab4fd0910bec06bb9a14725700","signerId":1},{"signature":"759952eddc35ce80488b0a6a7d0c9bef8d5e0718f89e6ed8b184f44ef5ad3c7649413d6f5eb71acbef83aafc343f0f00a3d68523f7e563b4b398507a15e10e1101","signerId":2},{"signature":"8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001","signerId":3}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	//  {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4},{"signature":"fe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00","signerId":5},{"signature":"6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00","signerId":8},{"signature":"914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01","signerId":9}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"fe77e1c59fd1d02327050fe942e220c7385fa363929fa4ecd47ca74c47836c955cef569b9390fe2141a5fee17af31ba262946d23e67f565df7cc578d2dd33c8f00","signerId":5},{"signature":"dd03d93eb6072e20c26abffa5f1deeeae9e8468fcb1d2b557c37ec8277c45a610aa0e607c3ab2d95c6d2d97ab01ac679311ab05be7c709ff7929523faa28ef4100","signerId":7},{"signature":"6a2538f9e0161417bae4e971a21d734d026bd7cd2b6086b8d1a1a37a8559f365762a5999cf63a1658a7cb05f7e4e50c7211648e189fe07d9c6e79811b0482caa00","signerId":8},{"signature":"914f3609ad4a5e51012d2b61247cd89b5e4a2a70bc7f4a9e16a16c24cf569ffc1af9d8d2fc5f1ef59412ae171ec37c417bb5f96434f70a5ec60736529f6e60bb01","signerId":9}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701","signerId":0},{"signature":"759952eddc35ce80488b0a6a7d0c9bef8d5e0718f89e6ed8b184f44ef5ad3c7649413d6f5eb71acbef83aafc343f0f00a3d68523f7e563b4b398507a15e10e1101","signerId":2},{"signature":"8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001","signerId":3},{"signature":"cc44f7db90cddf9a7e2c6cf57774235963ab3a75fc0f37e302aff9861021463a2119cf1a49702b80ae77ba78503463e53f3268fc37b9dce5342ecba16fa4146c01","signerId":6}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701","signerId":0},{"signature":"759952eddc35ce80488b0a6a7d0c9bef8d5e0718f89e6ed8b184f44ef5ad3c7649413d6f5eb71acbef83aafc343f0f00a3d68523f7e563b4b398507a15e10e1101","signerId":2},{"signature":"8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001","signerId":3},{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}
	// {"0xb8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309":{"rawReport":"016b9a69bb3e227cf6f8ec0457e81266765e1650a2c894ff16a0118d3d674f296c692c8fed0000000100000001005abdaec2b4e01b66d0b021ecb27d59ccf2868968de657c7ded9c37a3b03a1066666634313464303336dddddb8a8e41c194ac6542a0ad7ba663a72741e00004b8160fc063ca1b66f0a4f3e22ae18b43bae2da5d0a642a2354ce03fb71d65309","signs":[{"signature":"38f751ac0d2dbbd95899af72a3af32bbd69f01a77e87357dafde084ee432687c2b9597eaa6bf7d1903bb832edd7b762a0a65c68a8b76a39ee3575da20cc5599701","signerId":0},{"signature":"759952eddc35ce80488b0a6a7d0c9bef8d5e0718f89e6ed8b184f44ef5ad3c7649413d6f5eb71acbef83aafc343f0f00a3d68523f7e563b4b398507a15e10e1101","signerId":2},{"signature":"8561db7e6f3b02206b34f96a4a192723e81680f72713c475b86ab7e7efab939b61870bcf4a1aed7f52c80dbbf7f379ff06d6985f5439d3b37d2590c3ebfb46e001","signerId":3},{"signature":"e0056aaa5e01299b6e055dfa0a3fb7bc4dd3bf093f65ba9b20d2be736f468dc644946aa8ebffc64f0da34ea78612e0474a2a160e6a1239c2eeb839249bc5289900","signerId":4}],"reportContext":"000e8ce31db48e5e44619d24d9dadfc5f22a34db8205b2b25cd831eab02244c5000000000000000000000000000000000000000000000000000000004d44bb000000000000000000000000000000000000000000000000000000000000000000"}}

	const args = {
		messageReceipt:
			"0x01013882066eee000000000000000000000000000000000000000000000000000000000000000400001c07035637b260fbb1021a26bfe016306ecd09f3eb0000000000000000000018b87c9c797d6a888536eda952c5fb2b66351cc5fd000493e00000010000000100000000000100000601000000000000000c48656c6c6f20776f726c6421",
		validations: [validations],
		validatorLibs: [
			getEnvVar(`CONCERO_CRE_VALIDATOR_LIB_PROXY_${getNetworkEnvKey(networkName)}`),
		],
		relayerLib: getEnvVar(`CONCERO_RELAYER_LIB_PROXY_${getNetworkEnvKey(networkName)}`),
	};

	const hash = await walletClient.writeContract({
		address: conceroRouter,
		abi,
		functionName: "submitMessage",
		args: [args.messageReceipt, args.validations, args.validatorLibs, args.relayerLib],
		gas: 1_000_000n,
	});

	const { status } = await publicClient.waitForTransactionReceipt({ hash });

	log(status + " : " + hash, "submitMessage", networkName);
}

task("submit-message", "").setAction(async (taskArgs, hre: HardhatRuntimeEnvironment) => {
	await submitMessage(hre.network.name);
});

export { submitMessage };
